<!DOCTYPE html>
<html>

<head>
    {% load static %}
    <link rel="stylesheet" href="{% static 'cryptography/style.css' %}" />
    <link rel="stylesheet" href="{% static 'cryptography/result_style.css' %}" />
    <link rel="stylesheet" href="{% static 'global-styles.css' %}" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script>
        testval = "sdfjidsf";
        index = 0;

        step_index = 0;
        step_sub_index = 0;
        steps = {{steps|safe}}.steps;
        console.warn(steps);

        function printIndex(){
            console.warn(index);
            console.warn({{ steps | safe }});
            console.warn({{steps | safe}}.steps[0]);
        }

        // document.body.onload = loadStep;

        function clearStep(){
            document.getElementById('step-val').remove();
        }

        function clearSubStep(){
            document.getElementById('substep-val').remove();
        }

        function loadStep(){
            newDiv = document.createElement("div");
            newDiv.setAttribute('id', 'step-val');
            const newContent = document.createTextNode(JSON.stringify(steps[step_index]['chunk'])); //Set chunk to the right name
            // add the text node to the newly created div
            newDiv.appendChild(newContent);
            newDiv.onwheel = captureStep;
            const substepRef = document.createElement("div");
            substepRef.setAttribute('id', "substep-ref");
            newDiv.appendChild(substepRef);

            // add the newly created element and its content into the DOM
            const currentDiv = document.getElementById("step-reference");
            // console.warn(currentDiv);
            // console.warn(newDiv)
            // console.warn(document)
            document.getElementById("steps").insertBefore(newDiv, currentDiv);

            loadSubStep();
        }

        //mouse enter / leave
        function blockStepScroll(){
            console.warn("removed");
            document.getElementById('step-val').onwheel = null;
        }

        function enableStepScroll(){
            console.warn("added");
            let target = document.getElementById('step-val')
            // target.addEventListener('wheel', captureStep);
            // target.style.display = 'none';
            document.getElementById('step-val').onwheel = captureStep;
            
            // target.style.display = 'initial';
        }

        function captureSubStep($event){
            // console.warn("hi");
            // console.warn($event);
            // $event.stopImmediatePropogation();
            $event.preventDefault();

            if ($event.deltaY < 0) {
                //Scroll up
                prevSS();
            }
            else{
                //scroll down
                nextSS();
            }
        }

        function captureStep($event){
            // console.warn("hi");
            // console.warn($event);
            // $event.stopImmediatePropogation();

            // $event.stopPropogation();
            $event.preventDefault();
            if ($event.deltaY < 0) {
                //Scroll up
                prevS();
            }
            else{
                //scroll down
                nextS();
            }
        }

        function loadSubStep(){
            newDiv = document.createElement("div");
            newDiv.setAttribute('id', 'substep-val');
            newDiv.onwheel= captureSubStep;
            newDiv.onmouseenter = blockStepScroll;
            newDiv.onmouseleave = enableStepScroll;
            // const newContent = document.createTextNode(JSON.stringify(steps[step_index]['rounds'][step_sub_index])); //Set rounds to the right name
            const newContent = document.createTextNode(JSON.stringify(steps[step_index]['rounds'][step_sub_index], null, 2)); //Set rounds to the right name
            newDiv.appendChild(newContent);

            const currentDiv = document.getElementById("substep-ref");
            document.getElementById("step-val").insertBefore(newDiv, currentDiv);
        }

        function addButtons(){

        }


        function nextS(){
            clearStep();
            step_index = Math.min(steps.length-1, step_index + 1);
            step_sub_index=0;
            loadStep();
            // console.warn(step_index);
            // console.warn(step_sub_index);
        }

        function nextSS(){
            clearSubStep()
            // WHEN UPDATED TO DICT STRUCTURE
            // step_sub_index = Math.min(steps[step_index]['substeps'].length-1, step_sub_index + 1);
            step_sub_index = Math.min(steps[step_index]['rounds'].length-1, step_sub_index + 1);
            // console.warn(step_index);
            // console.warn(step_sub_index);
            loadSubStep();
        }

        function prevSS(){
            clearSubStep();
            step_sub_index = Math.max(0, step_sub_index - 1);
            // console.warn(step_index);
            // console.warn(step_sub_index);
            loadSubStep();
        }

        function prevS(){
            clearStep();
            step_index = Math.max(0, step_index - 1);
            step_sub_index=0;
            // console.warn(step_index);
            // console.warn(step_sub_index);
            loadStep();
        }

    </script>
</head>

<body onload="loadStep()">
    {{testval}}
    {% include "navbar.html" %}
    <main>
        {{resultForm}}
        <h1>{{resultForm.args.value.algo}} Encryption:</h1>
        <div id="results">
            <h2>Results:</h2>
            <p>Input: {{steps.msg}} </p>
            <p>Padding: {{steps.padding}}</p>
            <p>Result Hash: {{steps.hash}}</p>
        </div>
        <div id="steps"> 
            <h2>Steps:</h2>
            <div id="step-reference"></div>

            <!-- <form action="dec-result" method="post">
                {% csrf_token %}
                <div style="display: none;">
                    {{resultForm}}
                </div>
                <div>
                    <button type="submit">Decrease!</button>
                </div>
            </form>
            <form action="inc-result" method="post">
                {% csrf_token %}
                <div style="display: none;">
                    {{resultForm}}
                </div>
                <div>
                    <button type="submit">Increase!</button>
                </div>
            </form> -->
            <div id="buttons">
                <div class="step-button" onclick="prevS()">&langle;&langle;</div>
                <div class="step-button" onclick="prevSS()">&langle;</div>
                <div class="step-button" onclick="nextSS()">&rangle;</div>
                <div class="step-button" onclick="nextS()">&rangle;&rangle;</div>
            </div>
        </div>

        <!-- <div class="panel-group">
            {% for step in steps.steps %}
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" href="#collapse{{forloop.counter}}">Chunk
                            {{forloop.counter}}</a>
                    </h4>
                </div>
                <div id="collapse{{forloop.counter}}" class="panel-collapse collapse">
                    <div class="panel-body">
                        <div id="myCarousel{{forloop.counter}}" class="carousel slide" data-ride="carousel">
                            <div class="carousel-inner">
                                <p>Initial Word: {{step.w}}</p>

                                <a class="pull-left carousel-control-prev" href="#myCarousel{{forloop.counter}}" data-slide="prev">
                                    <span class="glyphicon glyphicon-chevron-left"></span>
                                    <span class="sr-only">Previous</span>
                                </a>
                                <a class="pull-right carousel-control-next" href="#myCarousel{{forloop.counter}}" data-slide="next">
                                    <span class="glyphicon glyphicon-chevron-right"></span>
                                    <span class="sr-only">Next</span>
                                </a>
                                Wrapper for slides
                                <div class="carousel-inner">
                                    {% for round in step.rounds %}
                                    <div class="item {%if forloop.counter == 1 %} active {% endif %}">
                                        Round: {{forloop.counter}}
                                        <ul>
                                            <li>a: {{round.a}}</li>
                                            <li>b: {{round.b}}</li>
                                            <li>c: {{round.c}}</li>
                                            <li>d: {{round.d}}</li>
                                            <li>e: {{round.e}}</li>
                                            <li>f: {{round.f}}</li>
                                            <li>g: {{round.g}}</li>
                                            <li>h: {{round.h}}</li>
                                            <li>temp1: {{round.temp1}}</li>
                                            <li>temp2: {{round.temp2}}</li>
                                        </ul>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            

                            Left and right controls
                            
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div> -->
    </main>
</body>

</html>